<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡å…¬ä¼—å· RSS ç”Ÿæˆå™¨</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“° å¾®ä¿¡å…¬ä¼—å· RSS ç”Ÿæˆå™¨</h1>
            <p class="subtitle">ä» EFB æ¶ˆæ¯è®°å½•ç”Ÿæˆ RSS è®¢é˜…æº</p>
        </header>

        <div class="search-box">
            <input 
                type="text" 
                id="search" 
                placeholder="æœç´¢å…¬ä¼—å·åç§°..." 
                autocomplete="off"
            >
        </div>

        <div class="stats" id="stats">æ­£åœ¨åŠ è½½...</div>

        <div class="mp-grid" id="mp-grid">
            <!-- MP cards will be inserted here -->
        </div>

        <!-- Modal for RSS URL -->
        <div class="modal" id="modal" onclick="closeModal(event)">
            <div class="modal-content" onclick="event.stopPropagation()">
                <span class="close-btn" onclick="closeModal()">&times;</span>
                <div class="mp-header" id="modal-header">
                    <img id="modal-img" src="" alt="">
                    <div>
                        <h2 id="modal-name"></h2>
                        <p id="modal-signature"></p>
                    </div>
                </div>
                <div class="rss-section">
                    <label>RSS è®¢é˜…é“¾æ¥:</label>
                    <div class="rss-url-box">
                        <input type="text" id="rss-url" readonly>
                        <button onclick="copyRssUrl()">å¤åˆ¶</button>
                        <button onclick="loadRssPreview()" class="preview-btn">é¢„è§ˆ</button>
                    </div>
                    <p class="copy-hint" id="copy-hint"></p>
                </div>
                <div class="rss-preview" id="rss-preview">
                    <div class="rss-preview-loading" id="rss-preview-loading" style="display:none;">åŠ è½½ä¸­...</div>
                    <div class="rss-preview-list" id="rss-preview-list"></div>
                </div>
            </div>
        </div>


    </div>

    <script>
        let allMps = [];
        
        async function loadMps() {
            try {
                const res = await fetch('/api/mps');
                allMps = await res.json();
                renderMps(allMps);
                document.getElementById('stats').textContent = 
                    `å…±æ‰¾åˆ° ${allMps.length} ä¸ªå…¬ä¼—å·`;
            } catch (err) {
                document.getElementById('stats').textContent = 'åŠ è½½å¤±è´¥: ' + err.message;
            }
        }
        
        function renderMps(mps) {
            const grid = document.getElementById('mp-grid');
            grid.innerHTML = mps.map(mp => `
                <div class="mp-card" onclick="showRssModal('${mp.puid}')">
                    <img src="${getHeadImgUrl(mp.head_img)}" alt="${mp.name}" loading="lazy"
                         onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23667eea%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2240%22>${mp.name.charAt(0)}</text></svg>'">
                    <div class="mp-info">
                        <h3>${escapeHtml(mp.name)}</h3>
                        <p>${escapeHtml(mp.signature || 'æš‚æ— ç®€ä»‹')}</p>
                    </div>
                </div>
            `).join('');
        }
        
        function getHeadImgUrl(path) {
            if (!path) return '';
            // WeChat head images need the wx.qq.com base
            if (path.startsWith('/cgi-bin/')) {
                return 'https://wx.qq.com' + path;
            }
            return path;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showRssModal(puid) {
            const mp = allMps.find(m => m.puid === puid);
            if (!mp) return;
            
            document.getElementById('modal-img').src = getHeadImgUrl(mp.head_img);
            document.getElementById('modal-name').textContent = mp.name;
            document.getElementById('modal-signature').textContent = mp.signature || 'æš‚æ— ç®€ä»‹';
            
            const rssUrl = `${window.location.origin}/api/rss/${puid}`;
            document.getElementById('rss-url').value = rssUrl;
            document.getElementById('copy-hint').textContent = '';
            document.getElementById('rss-preview-list').innerHTML = '';
            document.getElementById('rss-preview-loading').style.display = 'none';
            
            document.getElementById('modal').classList.add('show');
            loadRssPreview();
        }
        
        function closeModal(event) {
            if (!event || event.target.id === 'modal') {
                document.getElementById('modal').classList.remove('show');
            }
        }
        
        function copyRssUrl() {
            const input = document.getElementById('rss-url');
            input.select();
            document.execCommand('copy');
            document.getElementById('copy-hint').textContent = 'âœ“ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿';
        }
        
        async function loadRssPreview() {
            const rssUrl = document.getElementById('rss-url').value;
            const listEl = document.getElementById('rss-preview-list');
            const loadingEl = document.getElementById('rss-preview-loading');
            
            listEl.innerHTML = '';
            loadingEl.style.display = 'block';
            
            try {
                const res = await fetch(rssUrl);
                const text = await res.text();
                const parser = new DOMParser();
                const xml = parser.parseFromString(text, 'application/xml');
                const items = xml.querySelectorAll('item');
                
                if (items.length === 0) {
                    listEl.innerHTML = '<p class="rss-empty">æš‚æ— æ–‡ç« </p>';
                } else {
                    listEl.innerHTML = Array.from(items).slice(0, 10).map(item => {
                        const title = item.querySelector('title')?.textContent || 'æ— æ ‡é¢˜';
                        const link = item.querySelector('link')?.textContent || '#';
                        const pubDate = item.querySelector('pubDate')?.textContent || '';
                        const date = pubDate ? new Date(pubDate).toLocaleDateString('zh-CN') : '';
                        return `<a class="rss-item" href="${escapeHtml(link)}" target="_blank">
                            <span class="rss-item-title">${escapeHtml(title)}</span>
                            <span class="rss-item-date">${date}</span>
                        </a>`;
                    }).join('');
                }
            } catch (err) {
                listEl.innerHTML = `<p class="rss-error">åŠ è½½å¤±è´¥: ${escapeHtml(err.message)}</p>`;
            } finally {
                loadingEl.style.display = 'none';
            }
        }
        
        // Search functionality
        document.getElementById('search').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filtered = allMps.filter(mp => 
                mp.name.toLowerCase().includes(query) ||
                (mp.signature && mp.signature.toLowerCase().includes(query))
            );
            renderMps(filtered);
            document.getElementById('stats').textContent = 
                query ? `æ‰¾åˆ° ${filtered.length} ä¸ªåŒ¹é…` : `å…± ${allMps.length} ä¸ªå…¬ä¼—å·`;
        });
        
        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
        
        // Initial load
        loadMps();
    </script>
</body>
</html>
