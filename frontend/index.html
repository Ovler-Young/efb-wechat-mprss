<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡å…¬ä¼—å· RSS ç”Ÿæˆå™¨</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“° å¾®ä¿¡å…¬ä¼—å· RSS ç”Ÿæˆå™¨</h1>
            <p class="subtitle">ä» EFB æ¶ˆæ¯è®°å½•ç”Ÿæˆ RSS è®¢é˜…æº</p>
        </header>

        <div class="search-box">
            <input 
                type="text" 
                id="search" 
                placeholder="æœç´¢å…¬ä¼—å·åç§°..." 
                autocomplete="off"
            >
        </div>

        <div class="stats-bar">
            <div class="stats" id="stats">æ­£åœ¨åŠ è½½...</div>
            <button id="check-btn" class="check-btn" onclick="checkAllMpsRss()" disabled>æ£€æµ‹æ–‡ç« </button>
            <button id="export-btn" class="check-btn" onclick="enterSelectionMode()" disabled>å¯¼å‡º OPML</button>
        </div>

        <div class="selection-bar">
            <span class="selection-count" id="selection-count">å·²é€‰æ‹© 0 ä¸ª</span>
            <button onclick="selectAll()">å…¨é€‰</button>
            <button onclick="deselectAll()">å–æ¶ˆå…¨é€‰</button>
            <button class="export-btn" id="confirm-export-btn" onclick="exportSelectedOpml()" disabled>å¯¼å‡ºé€‰ä¸­</button>
            <button onclick="exitSelectionMode()">å–æ¶ˆ</button>
        </div>

        <div class="mp-grid" id="mp-grid">
            <!-- MP cards will be inserted here -->
        </div>

        <!-- Modal for RSS URL -->
        <div class="modal" id="modal" onclick="closeModal(event)">
            <div class="modal-content" onclick="event.stopPropagation()">
                <span class="close-btn" onclick="closeModal()">&times;</span>
                <div class="mp-header" id="modal-header">
                    <div>
                        <h2 id="modal-name"></h2>
                        <p id="modal-signature"></p>
                    </div>
                </div>
                <div class="rss-section">
                    <label>RSS è®¢é˜…é“¾æ¥:</label>
                    <div class="rss-url-box">
                        <input type="text" id="rss-url" readonly>
                        <button onclick="copyRssUrl()">å¤åˆ¶</button>
                        <button onclick="window.open(document.getElementById('rss-url').value, '_blank')" class="preview-btn">æ‰“å¼€</button>
                    </div>
                    <p class="copy-hint" id="copy-hint"></p>
                </div>
                <div class="rss-preview" id="rss-preview">
                    <div class="rss-preview-loading" id="rss-preview-loading" style="display:none;">åŠ è½½ä¸­...</div>
                    <div class="rss-preview-list" id="rss-preview-list"></div>
                </div>
            </div>
        </div>


    </div>

    <script>
        let allMps = [];
        
        async function loadMps() {
            try {
                const res = await fetch('/api/mps');
                allMps = await res.json();
                renderMps(allMps);
                document.getElementById('stats').textContent = 
                    `å…±æ‰¾åˆ° ${allMps.length} ä¸ªå…¬ä¼—å·`;
            } catch (err) {
                document.getElementById('stats').textContent = 'åŠ è½½å¤±è´¥: ' + err.message;
            }
        }
        
        function renderMps(mps) {
            const grid = document.getElementById('mp-grid');
            grid.innerHTML = mps.map(mp => `
                <div class="mp-card" data-puid="${mp.puid}" onclick="handleCardClick('${mp.puid}')">
                    <div class="mp-info">
                        <h3>${escapeHtml(mp.name)}</h3>
                        <p>${escapeHtml(mp.signature || 'æš‚æ— ç®€ä»‹')}</p>
                    </div>
                    <span class="mp-status"></span>
                </div>
            `).join('');
        }
        
        // Selection mode state
        let selectionMode = false;
        let selectedPuids = new Set();
        let articleCheckDone = false;
        
        function handleCardClick(puid) {
            if (selectionMode) {
                toggleSelect(puid);
            } else {
                showRssModal(puid);
            }
        }
        
        function enterSelectionMode() {
            if (!articleCheckDone) {
                alert('è¯·å…ˆç‚¹å‡»"æ£€æµ‹æ–‡ç« "åå†å¯¼å‡º');
                return;
            }
            selectionMode = true;
            selectedPuids.clear();
            document.querySelector('.container').classList.add('selection-mode');
            updateSelectionCount();
        }
        
        function exitSelectionMode() {
            selectionMode = false;
            selectedPuids.clear();
            document.querySelector('.container').classList.remove('selection-mode');
            document.querySelectorAll('.mp-card.selected').forEach(c => c.classList.remove('selected'));
        }
        
        function toggleSelect(puid) {
            const card = document.querySelector(`.mp-card[data-puid="${puid}"]`);
            if (!card) return;
            
            if (selectedPuids.has(puid)) {
                selectedPuids.delete(puid);
                card.classList.remove('selected');
            } else {
                selectedPuids.add(puid);
                card.classList.add('selected');
            }
            updateSelectionCount();
        }
        
        function selectAll() {
            document.querySelectorAll('.mp-card:not(.mp-card-empty)').forEach(card => {
                const puid = card.dataset.puid;
                selectedPuids.add(puid);
                card.classList.add('selected');
            });
            updateSelectionCount();
        }
        
        function deselectAll() {
            selectedPuids.clear();
            document.querySelectorAll('.mp-card.selected').forEach(c => c.classList.remove('selected'));
            updateSelectionCount();
        }
        
        function updateSelectionCount() {
            const count = selectedPuids.size;
            document.getElementById('selection-count').textContent = `å·²é€‰æ‹© ${count} ä¸ª`;
            document.getElementById('confirm-export-btn').disabled = count === 0;
        }
        
        async function exportSelectedOpml() {
            if (selectedPuids.size === 0) return;
            
            try {
                const res = await fetch('/api/opml', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ puids: Array.from(selectedPuids) })
                });
                
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'wechat-mp-feeds.opml';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                exitSelectionMode();
            } catch (err) {
                alert('å¯¼å‡ºå¤±è´¥: ' + err.message);
            }
        }
        

        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showRssModal(puid) {
            const mp = allMps.find(m => m.puid === puid);
            if (!mp) return;
            

            document.getElementById('modal-name').textContent = mp.name;
            document.getElementById('modal-signature').textContent = mp.signature || 'æš‚æ— ç®€ä»‹';
            
            const rssUrl = `${window.location.origin}/api/rss/${puid}`;
            document.getElementById('rss-url').value = rssUrl;
            document.getElementById('copy-hint').textContent = '';
            document.getElementById('rss-preview-list').innerHTML = '';
            document.getElementById('rss-preview-loading').style.display = 'none';
            
            document.getElementById('modal').classList.add('show');
            loadRssPreview();
        }
        
        function closeModal(event) {
            if (!event || event.target.id === 'modal') {
                document.getElementById('modal').classList.remove('show');
            }
        }
        
        async function copyRssUrl() {
            const input = document.getElementById('rss-url');
            try {
                await navigator.clipboard.writeText(input.value);
                document.getElementById('copy-hint').textContent = 'âœ“ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿';
            } catch (err) {
                // Fallback for older browsers or non-HTTPS
                input.select();
                document.execCommand('copy');
                document.getElementById('copy-hint').textContent = 'âœ“ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿';
            }
        }
        

        
        async function loadRssPreview() {
            const rssUrl = document.getElementById('rss-url').value;
            const listEl = document.getElementById('rss-preview-list');
            const loadingEl = document.getElementById('rss-preview-loading');
            
            listEl.innerHTML = '';
            loadingEl.style.display = 'block';
            
            try {
                const res = await fetch(rssUrl);
                const text = await res.text();
                const parser = new DOMParser();
                const xml = parser.parseFromString(text, 'application/xml');
                const items = xml.querySelectorAll('item');
                
                if (items.length === 0) {
                    listEl.innerHTML = '<p class="rss-empty">æš‚æ— æ–‡ç« </p>';
                } else {
                    listEl.innerHTML = Array.from(items).slice(0, 10).map(item => {
                        const title = item.querySelector('title')?.textContent || 'æ— æ ‡é¢˜';
                        const link = item.querySelector('link')?.textContent || '#';
                        const pubDate = item.querySelector('pubDate')?.textContent || '';
                        const date = pubDate ? new Date(pubDate).toLocaleDateString('zh-CN') : '';
                        return `<a class="rss-item" href="${escapeHtml(link)}" target="_blank">
                            <span class="rss-item-title">${escapeHtml(title)}</span>
                            <span class="rss-item-date">${date}</span>
                        </a>`;
                    }).join('');
                }
            } catch (err) {
                listEl.innerHTML = `<p class="rss-error">åŠ è½½å¤±è´¥: ${escapeHtml(err.message)}</p>`;
            } finally {
                loadingEl.style.display = 'none';
            }
        }
        
        // Search functionality
        document.getElementById('search').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filtered = allMps.filter(mp => 
                mp.name.toLowerCase().includes(query) ||
                (mp.signature && mp.signature.toLowerCase().includes(query))
            );
            renderMps(filtered);
            document.getElementById('stats').textContent = 
                query ? `æ‰¾åˆ° ${filtered.length} ä¸ªåŒ¹é…` : `å…± ${allMps.length} ä¸ªå…¬ä¼—å·`;
        });
        
        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
        
        // Initial load
        loadMps().then(() => {
            document.getElementById('check-btn').disabled = false;
        });
        
        async function checkAllMpsRss() {
            const total = allMps.length;
            document.getElementById('stats').textContent = `æ­£åœ¨æ£€æŸ¥ ${total} ä¸ªå…¬ä¼—å·...`;
            
            try {
                const res = await fetch(`${window.location.origin}/api/article-counts-batch`);
                const data = await res.json();
                
                let withArticles = 0;
                let empty = 0;
                
                for (const mp of allMps) {
                    const card = document.querySelector(`.mp-card[data-puid="${mp.puid}"]`);
                    if (!card) continue;
                    
                    const statusEl = card.querySelector('.mp-status');
                    const count = data[mp.puid];
                    
                    if (count === undefined) {
                        statusEl.textContent = 'æœªçŸ¥';
                    } else if (count === 0) {
                        card.classList.add('mp-card-empty');
                        statusEl.textContent = 'æ— æ–‡ç« ';
                        empty++;
                    } else {
                        statusEl.textContent = `${count} ç¯‡`;
                        withArticles++;
                    }
                }
                
                reorderMps();
                articleCheckDone = true;
                document.getElementById('export-btn').disabled = false;
                document.getElementById('stats').textContent = 
                    `å…± ${total} ä¸ªå…¬ä¼—å· | æœ‰æ–‡ç« : ${withArticles} | æ— æ–‡ç« : ${empty}`;
            } catch (err) {
                document.getElementById('stats').textContent = `æ£€æŸ¥å¤±è´¥: ${err.message}`;
            }
        }
        
        function reorderMps() {
            const grid = document.getElementById('mp-grid');
            const cards = Array.from(grid.querySelectorAll('.mp-card'));
            const withArticles = cards.filter(c => !c.classList.contains('mp-card-empty'));
            const empties = cards.filter(c => c.classList.contains('mp-card-empty'));
            grid.innerHTML = '';
            withArticles.forEach(c => grid.appendChild(c));
            empties.forEach(c => grid.appendChild(c));
        }
    </script>
</body>
</html>
