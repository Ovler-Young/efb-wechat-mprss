<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡å…¬ä¼—å· RSS ç”Ÿæˆå™¨</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“° å¾®ä¿¡å…¬ä¼—å· RSS ç”Ÿæˆå™¨</h1>
            <p class="subtitle">ä» EFB æ¶ˆæ¯è®°å½•ç”Ÿæˆ RSS è®¢é˜…æº</p>
        </header>

        <div class="search-box">
            <input 
                type="text" 
                id="search" 
                placeholder="æœç´¢å…¬ä¼—å·åç§°..." 
                autocomplete="off"
            >
        </div>

        <div class="stats-bar">
            <div class="stats" id="stats">æ­£åœ¨åŠ è½½...</div>
            <button id="check-btn" class="check-btn" onclick="checkAllMpsRss()" disabled>æ£€æµ‹æ–‡ç« </button>
            <button id="manage-tags-btn" class="check-btn" onclick="openTagManager()">ç®¡ç†æ ‡ç­¾</button>
            <button id="export-btn" class="check-btn" onclick="enterSelectionMode()" disabled>å¯¼å‡º OPML</button>
        </div>

        <div class="selection-bar">
            <span class="selection-count" id="selection-count">å·²é€‰æ‹© 0 ä¸ª</span>
            <button onclick="selectAll()">å…¨é€‰</button>
            <button onclick="deselectAll()">å–æ¶ˆå…¨é€‰</button>
            <button class="settings-btn" onclick="openExportSettings()">âš™ è®¾ç½®</button>
            <button class="export-btn" id="confirm-export-btn" onclick="exportSelectedOpml()" disabled>å¯¼å‡ºé€‰ä¸­</button>
            <button onclick="exitSelectionMode()">å–æ¶ˆ</button>
        </div>

        <div class="mp-grid" id="mp-grid">
            <!-- MP cards will be inserted here -->
        </div>

        <!-- Modal for RSS URL -->
        <div class="modal" id="modal" onclick="closeModal(event)">
            <div class="modal-content" onclick="event.stopPropagation()">
                <span class="close-btn" onclick="closeModal()">&times;</span>
                <div class="mp-header" id="modal-header">
                    <div>
                        <h2 id="modal-name"></h2>
                        <p id="modal-signature"></p>
                    </div>
                </div>
                <div class="rss-section">
                    <label>RSS è®¢é˜…é“¾æ¥:</label>
                    <div class="rss-url-box">
                        <input type="text" id="rss-url" readonly>
                        <button onclick="copyRssUrl()">å¤åˆ¶</button>
                        <button onclick="window.open(document.getElementById('rss-url').value, '_blank')" class="preview-btn">æ‰“å¼€</button>
                    </div>
                    <p class="copy-hint" id="copy-hint"></p>
                </div>
                <div class="rss-preview" id="rss-preview">
                    <div class="rss-preview-loading" id="rss-preview-loading" style="display:none;">åŠ è½½ä¸­...</div>
                    <div class="rss-preview-list" id="rss-preview-list"></div>
                </div>
            </div>
        </div>

        <!-- Tag Manager Modal -->
        <div class="modal" id="tag-modal" onclick="closeTagManager(event)">
            <div class="modal-content tag-manager-content" onclick="event.stopPropagation()">
                <span class="close-btn" onclick="closeTagManager()">&times;</span>
                <h2>ç®¡ç†æ ‡ç­¾</h2>
                <div class="tag-input-row">
                    <input type="text" id="new-tag-input" placeholder="è¾“å…¥æ–°æ ‡ç­¾åç§°..." onkeypress="if(event.key==='Enter')addTag()">
                    <button onclick="addTag()">æ·»åŠ </button>
                </div>
                <div class="tag-list" id="tag-list">
                    <!-- Tags will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Context Menu for Tag Selection -->
        <div class="context-menu" id="context-menu">
            <div class="context-menu-title">é€‰æ‹©æ ‡ç­¾</div>
            <div class="context-menu-items" id="context-menu-items">
                <!-- Tag options will be inserted here -->
            </div>
        </div>

        <!-- Export Settings Modal -->
        <div class="modal" id="export-settings-modal" onclick="closeExportSettings(event)">
            <div class="modal-content tag-manager-content" onclick="event.stopPropagation()">
                <span class="close-btn" onclick="closeExportSettings()">&times;</span>
                <h2>å¯¼å‡ºè®¾ç½®</h2>
                <div class="settings-section">
                    <label for="url-prefix-input">å…¨æ–‡ä»£ç†å‰ç¼€ (å¯é€‰)</label>
                    <p class="settings-hint">è®¾ç½®å RSS åœ°å€å°†å˜ä¸ºï¼šå‰ç¼€/åŸŸå/api/rss/puid</p>
                    <input type="text" id="url-prefix-input" placeholder="ä¾‹å¦‚ https://morss.example.com/">
                    <p class="settings-example" id="prefix-preview"></p>
                </div>
                <div class="settings-actions">
                    <button class="settings-clear" onclick="clearUrlPrefix()">æ¸…é™¤</button>
                    <button class="settings-save" onclick="saveExportSettings()">ä¿å­˜</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        let allMps = [];
        
        // Tag storage
        let tagList = JSON.parse(localStorage.getItem('mpTagList') || '[]');
        let mpTags = JSON.parse(localStorage.getItem('mpTags') || '{}');
        
        function saveTags() {
            localStorage.setItem('mpTagList', JSON.stringify(tagList));
            localStorage.setItem('mpTags', JSON.stringify(mpTags));
        }
        
        async function loadMps() {
            try {
                const res = await fetch('/api/mps');
                allMps = await res.json();
                renderMps(allMps);
                document.getElementById('stats').textContent = 
                    `å…±æ‰¾åˆ° ${allMps.length} ä¸ªå…¬ä¼—å·`;
            } catch (err) {
                document.getElementById('stats').textContent = 'åŠ è½½å¤±è´¥: ' + err.message;
            }
        }
        
        function renderMps(mps) {
            const grid = document.getElementById('mp-grid');
            grid.innerHTML = mps.map(mp => {
                const tag = mpTags[mp.puid] || '';
                const tagHtml = tag ? `<span class="mp-tag">${escapeHtml(tag)}</span>` : '';
                return `
                <div class="mp-card" data-puid="${mp.puid}" onclick="handleCardClick('${mp.puid}')" oncontextmenu="showContextMenu(event, '${mp.puid}')">
                    <div class="mp-info">
                        <h3>${escapeHtml(mp.name)}</h3>
                        <p>${escapeHtml(mp.signature || 'æš‚æ— ç®€ä»‹')}</p>
                    </div>
                    ${tagHtml}
                    <span class="mp-status"></span>
                </div>
            `}).join('');
        }
        
        // Selection mode state
        let selectionMode = false;
        let selectedPuids = new Set();
        let articleCheckDone = false;
        
        function handleCardClick(puid) {
            if (selectionMode) {
                toggleSelect(puid);
            } else {
                showRssModal(puid);
            }
        }
        
        function enterSelectionMode() {
            if (!articleCheckDone) {
                alert('è¯·å…ˆç‚¹å‡»"æ£€æµ‹æ–‡ç« "åå†å¯¼å‡º');
                return;
            }
            selectionMode = true;
            selectedPuids.clear();
            document.querySelector('.container').classList.add('selection-mode');
            
            // Auto-select all MPs with tags
            for (const puid in mpTags) {
                const card = document.querySelector(`.mp-card[data-puid="${puid}"]`);
                if (card && !card.classList.contains('mp-card-empty')) {
                    selectedPuids.add(puid);
                    card.classList.add('selected');
                }
            }
            
            updateSelectionCount();
        }
        
        function exitSelectionMode() {
            selectionMode = false;
            selectedPuids.clear();
            document.querySelector('.container').classList.remove('selection-mode');
            document.querySelectorAll('.mp-card.selected').forEach(c => c.classList.remove('selected'));
        }
        
        function toggleSelect(puid) {
            const card = document.querySelector(`.mp-card[data-puid="${puid}"]`);
            if (!card) return;
            
            if (selectedPuids.has(puid)) {
                selectedPuids.delete(puid);
                card.classList.remove('selected');
            } else {
                selectedPuids.add(puid);
                card.classList.add('selected');
            }
            updateSelectionCount();
        }
        
        function selectAll() {
            document.querySelectorAll('.mp-card:not(.mp-card-empty)').forEach(card => {
                const puid = card.dataset.puid;
                selectedPuids.add(puid);
                card.classList.add('selected');
            });
            updateSelectionCount();
        }
        
        function deselectAll() {
            selectedPuids.clear();
            document.querySelectorAll('.mp-card.selected').forEach(c => c.classList.remove('selected'));
            updateSelectionCount();
        }
        
        function updateSelectionCount() {
            const count = selectedPuids.size;
            document.getElementById('selection-count').textContent = `å·²é€‰æ‹© ${count} ä¸ª`;
            document.getElementById('confirm-export-btn').disabled = count === 0;
        }
        
        async function exportSelectedOpml() {
            if (selectedPuids.size === 0) return;
            
            // Build groups object for selected puids
            const groups = {};
            for (const puid of selectedPuids) {
                if (mpTags[puid]) {
                    groups[puid] = mpTags[puid];
                }
                // If no tag, it will be placed in "All" by backend
            }
            
            try {
                const res = await fetch('/api/opml', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        puids: Array.from(selectedPuids),
                        groups: Object.keys(groups).length > 0 ? groups : null,
                        url_prefix: localStorage.getItem('opmlUrlPrefix') || null
                    })
                });
                
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'wechat-mp-feeds.opml';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                exitSelectionMode();
            } catch (err) {
                alert('å¯¼å‡ºå¤±è´¥: ' + err.message);
            }
        }
        
        // ===== Export Settings =====
        function openExportSettings() {
            const savedPrefix = localStorage.getItem('opmlUrlPrefix') || '';
            document.getElementById('url-prefix-input').value = savedPrefix;
            updatePrefixPreview();
            document.getElementById('export-settings-modal').classList.add('show');
        }
        
        function closeExportSettings(event) {
            if (!event || event.target.id === 'export-settings-modal') {
                document.getElementById('export-settings-modal').classList.remove('show');
            }
        }
        
        function updatePrefixPreview() {
            const prefix = document.getElementById('url-prefix-input').value.trim();
            const previewEl = document.getElementById('prefix-preview');
            if (prefix) {
                const domain = window.location.host;
                previewEl.textContent = `ç¤ºä¾‹: ${prefix.replace(/\/$/, '')}/${domain}/api/rss/xxx`;
                previewEl.style.display = 'block';
            } else {
                previewEl.style.display = 'none';
            }
        }
        
        function saveExportSettings() {
            const prefix = document.getElementById('url-prefix-input').value.trim();
            if (prefix) {
                localStorage.setItem('opmlUrlPrefix', prefix);
            } else {
                localStorage.removeItem('opmlUrlPrefix');
            }
            closeExportSettings();
        }
        
        function clearUrlPrefix() {
            document.getElementById('url-prefix-input').value = '';
            updatePrefixPreview();
        }
        
        // Update preview on input
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('url-prefix-input');
            if (input) input.addEventListener('input', updatePrefixPreview);
        });
        
        // ===== Tag Manager =====
        function openTagManager() {
            renderTagList();
            document.getElementById('tag-modal').classList.add('show');
        }
        
        function closeTagManager(event) {
            if (!event || event.target.id === 'tag-modal') {
                document.getElementById('tag-modal').classList.remove('show');
            }
        }
        
        function renderTagList() {
            const list = document.getElementById('tag-list');
            if (tagList.length === 0) {
                list.innerHTML = '<p class="tag-empty">æš‚æ— æ ‡ç­¾ï¼Œè¯·æ·»åŠ </p>';
                return;
            }
            list.innerHTML = tagList.map(tag => `
                <div class="tag-item">
                    <span>${escapeHtml(tag)}</span>
                    <button class="tag-delete-btn" onclick="deleteTag('${escapeHtml(tag)}')">&times;</button>
                </div>
            `).join('');
        }
        
        function addTag() {
            const input = document.getElementById('new-tag-input');
            const name = input.value.trim();
            if (!name) return;
            if (tagList.includes(name)) {
                alert('æ ‡ç­¾å·²å­˜åœ¨');
                return;
            }
            tagList.push(name);
            saveTags();
            renderTagList();
            input.value = '';
        }
        
        function deleteTag(name) {
            if (!confirm(`ç¡®å®šåˆ é™¤æ ‡ç­¾ "${name}"ï¼Ÿå·²åˆ†é…è¯¥æ ‡ç­¾çš„å…¬ä¼—å·å°†å˜ä¸ºæœªåˆ†ç±»ã€‚`)) return;
            tagList = tagList.filter(t => t !== name);
            // Remove tag from all MPs that had it
            for (const puid in mpTags) {
                if (mpTags[puid] === name) {
                    delete mpTags[puid];
                }
            }
            saveTags();
            renderTagList();
            renderMps(allMps);
        }
        
        // ===== Context Menu =====
        let contextMenuPuid = null;
        
        function showContextMenu(event, puid) {
            event.preventDefault();
            contextMenuPuid = puid;
            
            const menu = document.getElementById('context-menu');
            const items = document.getElementById('context-menu-items');
            
            // Build menu items
            const currentTag = mpTags[puid] || '';
            let html = `<div class="context-menu-item ${!currentTag ? 'active' : ''}" onclick="setMpTag(null)">æ— æ ‡ç­¾ (All)</div>`;
            html += tagList.map(tag => 
                `<div class="context-menu-item ${currentTag === tag ? 'active' : ''}" onclick="setMpTag('${escapeHtml(tag)}')">${escapeHtml(tag)}</div>`
            ).join('');
            html += `<div class="context-menu-item context-menu-add" onclick="addTagFromMenu()">+ æ–°æ ‡ç­¾</div>`;
            items.innerHTML = html;
            
            // Position menu
            menu.style.left = event.clientX + 'px';
            menu.style.top = event.clientY + 'px';
            menu.classList.add('show');
            
            // Close on next click
            setTimeout(() => {
                document.addEventListener('click', hideContextMenu, { once: true });
            }, 0);
        }
        
        function hideContextMenu() {
            document.getElementById('context-menu').classList.remove('show');
            contextMenuPuid = null;
        }
        
        function addTagFromMenu() {
            const name = prompt('è¾“å…¥æ–°æ ‡ç­¾åç§°:');
            if (!name || !name.trim()) {
                hideContextMenu();
                return;
            }
            const trimmed = name.trim();
            if (!tagList.includes(trimmed)) {
                tagList.push(trimmed);
            }
            setMpTag(trimmed);
        }
        
        function setMpTag(tag) {
            if (!contextMenuPuid) return;
            if (tag) {
                mpTags[contextMenuPuid] = tag;
            } else {
                delete mpTags[contextMenuPuid];
            }
            saveTags();
            
            // Update card display
            const card = document.querySelector(`.mp-card[data-puid="${contextMenuPuid}"]`);
            if (card) {
                const existingTag = card.querySelector('.mp-tag');
                if (existingTag) existingTag.remove();
                if (tag) {
                    const tagEl = document.createElement('span');
                    tagEl.className = 'mp-tag';
                    tagEl.textContent = tag;
                    card.appendChild(tagEl);
                }
            }
            
            hideContextMenu();
        }

        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showRssModal(puid) {
            const mp = allMps.find(m => m.puid === puid);
            if (!mp) return;
            

            document.getElementById('modal-name').textContent = mp.name;
            document.getElementById('modal-signature').textContent = mp.signature || 'æš‚æ— ç®€ä»‹';
            
            const rssUrl = `${window.location.origin}/api/rss/${puid}`;
            document.getElementById('rss-url').value = rssUrl;
            document.getElementById('copy-hint').textContent = '';
            document.getElementById('rss-preview-list').innerHTML = '';
            document.getElementById('rss-preview-loading').style.display = 'none';
            
            document.getElementById('modal').classList.add('show');
            loadRssPreview();
        }
        
        function closeModal(event) {
            if (!event || event.target.id === 'modal') {
                document.getElementById('modal').classList.remove('show');
            }
        }
        
        async function copyRssUrl() {
            const input = document.getElementById('rss-url');
            try {
                await navigator.clipboard.writeText(input.value);
                document.getElementById('copy-hint').textContent = 'âœ“ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿';
            } catch (err) {
                // Fallback for older browsers or non-HTTPS
                input.select();
                document.execCommand('copy');
                document.getElementById('copy-hint').textContent = 'âœ“ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿';
            }
        }
        

        
        async function loadRssPreview() {
            const rssUrl = document.getElementById('rss-url').value;
            const listEl = document.getElementById('rss-preview-list');
            const loadingEl = document.getElementById('rss-preview-loading');
            
            listEl.innerHTML = '';
            loadingEl.style.display = 'block';
            
            try {
                const res = await fetch(rssUrl);
                const text = await res.text();
                const parser = new DOMParser();
                const xml = parser.parseFromString(text, 'application/xml');
                const items = xml.querySelectorAll('item');
                
                if (items.length === 0) {
                    listEl.innerHTML = '<p class="rss-empty">æš‚æ— æ–‡ç« </p>';
                } else {
                    listEl.innerHTML = Array.from(items).slice(0, 10).map(item => {
                        const title = item.querySelector('title')?.textContent || 'æ— æ ‡é¢˜';
                        const link = item.querySelector('link')?.textContent || '#';
                        const pubDate = item.querySelector('pubDate')?.textContent || '';
                        const date = pubDate ? new Date(pubDate).toLocaleDateString('zh-CN') : '';
                        return `<a class="rss-item" href="${escapeHtml(link)}" target="_blank">
                            <span class="rss-item-title">${escapeHtml(title)}</span>
                            <span class="rss-item-date">${date}</span>
                        </a>`;
                    }).join('');
                }
            } catch (err) {
                listEl.innerHTML = `<p class="rss-error">åŠ è½½å¤±è´¥: ${escapeHtml(err.message)}</p>`;
            } finally {
                loadingEl.style.display = 'none';
            }
        }
        
        // Search functionality
        document.getElementById('search').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filtered = allMps.filter(mp => 
                mp.name.toLowerCase().includes(query) ||
                (mp.signature && mp.signature.toLowerCase().includes(query))
            );
            renderMps(filtered);
            document.getElementById('stats').textContent = 
                query ? `æ‰¾åˆ° ${filtered.length} ä¸ªåŒ¹é…` : `å…± ${allMps.length} ä¸ªå…¬ä¼—å·`;
        });
        
        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeTagManager();
                hideContextMenu();
            }
        });
        
        // Initial load
        loadMps().then(() => {
            document.getElementById('check-btn').disabled = false;
        });
        
        async function checkAllMpsRss() {
            const total = allMps.length;
            document.getElementById('stats').textContent = `æ­£åœ¨æ£€æŸ¥ ${total} ä¸ªå…¬ä¼—å·...`;
            
            try {
                const res = await fetch(`${window.location.origin}/api/article-counts-batch`);
                const data = await res.json();
                
                let withArticles = 0;
                let empty = 0;
                
                for (const mp of allMps) {
                    const card = document.querySelector(`.mp-card[data-puid="${mp.puid}"]`);
                    if (!card) continue;
                    
                    const statusEl = card.querySelector('.mp-status');
                    const count = data[mp.puid];
                    
                    if (count === undefined) {
                        statusEl.textContent = 'æœªçŸ¥';
                    } else if (count === 0) {
                        card.classList.add('mp-card-empty');
                        statusEl.textContent = 'æ— æ–‡ç« ';
                        empty++;
                    } else {
                        statusEl.textContent = `${count} ç¯‡`;
                        withArticles++;
                    }
                }
                
                reorderMps();
                articleCheckDone = true;
                document.getElementById('export-btn').disabled = false;
                document.getElementById('stats').textContent = 
                    `å…± ${total} ä¸ªå…¬ä¼—å· | æœ‰æ–‡ç« : ${withArticles} | æ— æ–‡ç« : ${empty}`;
            } catch (err) {
                document.getElementById('stats').textContent = `æ£€æŸ¥å¤±è´¥: ${err.message}`;
            }
        }
        
        function reorderMps() {
            const grid = document.getElementById('mp-grid');
            const cards = Array.from(grid.querySelectorAll('.mp-card'));
            const withArticles = cards.filter(c => !c.classList.contains('mp-card-empty'));
            const empties = cards.filter(c => c.classList.contains('mp-card-empty'));
            grid.innerHTML = '';
            withArticles.forEach(c => grid.appendChild(c));
            empties.forEach(c => grid.appendChild(c));
        }
    </script>
</body>
</html>
